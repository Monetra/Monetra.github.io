<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mstdlib-1.17.0: Proxy Protocol</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mstdlib-1.17.0
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('group__m__io__proxy__protocol.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#enum-members">Enumerations</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">Proxy Protocol<div class="ingroups"><a class="el" href="group__m__eventio.html">Event Based I/O Subsystem</a> &raquo; <a class="el" href="group__m__eventio__base__addon.html">Add-on IO layers</a></div></div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:ga07c46f091a99fdaac9e9bd23c599d67f"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga07c46f091a99fdaac9e9bd23c599d67f">M_io_proxy_protocol_flags_t</a> { <br />
&#160;&#160;<a class="el" href="group__m__io__proxy__protocol.html#gga07c46f091a99fdaac9e9bd23c599d67fa5bbdffd4b22645f75bd0cb9510fe50c8">M_IO_PROXY_PROTOCOL_FLAG_NONE</a> = 0
, <br />
&#160;&#160;<a class="el" href="group__m__io__proxy__protocol.html#gga07c46f091a99fdaac9e9bd23c599d67fac8f1c35a2d4e078f9a4e1c369585a3d5">M_IO_PROXY_PROTOCOL_FLAG_V1</a> = 1 &lt;&lt; 0
, <br />
&#160;&#160;<a class="el" href="group__m__io__proxy__protocol.html#gga07c46f091a99fdaac9e9bd23c599d67fadbd9012cd8e75280d765ca582d5dc1fc">M_IO_PROXY_PROTOCOL_FLAG_V2</a> = 1 &lt;&lt; 1
<br />
 }</td></tr>
<tr class="separator:ga07c46f091a99fdaac9e9bd23c599d67f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gabe9d93489ff87f2a0b54a3bb7edb3e35"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#gabe9d93489ff87f2a0b54a3bb7edb3e35">M_io_proxy_protocol_inbound_add</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, size_t *layer_id, M_uint32 flags)</td></tr>
<tr class="separator:gabe9d93489ff87f2a0b54a3bb7edb3e35"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa6382c849d8aeda4b03d365c6f811a60"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#gaa6382c849d8aeda4b03d365c6f811a60">M_io_proxy_protocol_outbound_add</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, size_t *layer_id, M_uint32 flags)</td></tr>
<tr class="separator:gaa6382c849d8aeda4b03d365c6f811a60"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9c879581948a7071a96fd5c77c4db4b2"><td class="memItemLeft" align="right" valign="top">M_bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga9c879581948a7071a96fd5c77c4db4b2">M_io_proxy_protocol_relayed</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:ga9c879581948a7071a96fd5c77c4db4b2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4bb6960e44981297a6a01348252327e5"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga4bb6960e44981297a6a01348252327e5">M_io_proxy_protocol_source_ipaddr</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:ga4bb6960e44981297a6a01348252327e5"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaeef527389ce51d5bfc88abf50cde416b"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#gaeef527389ce51d5bfc88abf50cde416b">M_io_proxy_protocol_dest_ipaddr</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:gaeef527389ce51d5bfc88abf50cde416b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad8431b167cf43e4f48690ab943272cab"><td class="memItemLeft" align="right" valign="top">M_uint16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#gad8431b167cf43e4f48690ab943272cab">M_io_proxy_protocol_source_port</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:gad8431b167cf43e4f48690ab943272cab"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa24ad926cb118e7260ebb5e26c8057b2"><td class="memItemLeft" align="right" valign="top">M_uint16&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#gaa24ad926cb118e7260ebb5e26c8057b2">M_io_proxy_protocol_dest_port</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:gaa24ad926cb118e7260ebb5e26c8057b2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga4721163ab454a575722f3fd628702b71"><td class="memItemLeft" align="right" valign="top"><a class="el" href="group__m__io__net.html#ga0d3c956e19a647267f818beb367de6bc">M_io_net_type_t</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga4721163ab454a575722f3fd628702b71">M_io_proxy_protocol_proxied_type</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:ga4721163ab454a575722f3fd628702b71"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5f11acf1e855088b6c899224c06003b8"><td class="memItemLeft" align="right" valign="top">const char *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga5f11acf1e855088b6c899224c06003b8">M_io_proxy_protocol_get_ipaddr</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io)</td></tr>
<tr class="separator:ga5f11acf1e855088b6c899224c06003b8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5004b110af7c31ec4dbbe2b6a0961eae"><td class="memItemLeft" align="right" valign="top">M_bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga5004b110af7c31ec4dbbe2b6a0961eae">M_io_proxy_protocol_set_connect_timeout_ms</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, M_uint64 timeout_ms)</td></tr>
<tr class="separator:ga5004b110af7c31ec4dbbe2b6a0961eae"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga263a6cac977efe462bb133a1a562a7c6"><td class="memItemLeft" align="right" valign="top">M_bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__m__io__proxy__protocol.html#ga263a6cac977efe462bb133a1a562a7c6">M_io_proxy_protocol_set_source_endpoints</a> (<a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, const char *source_ipaddr, const char *dest_ipaddr, M_uint16 source_port, M_uint16 dest_port)</td></tr>
<tr class="separator:ga263a6cac977efe462bb133a1a562a7c6"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h1><a class="anchor" id="autotoc_md71"></a>
Overview</h1>
<p>Inbound or outbound connection layer for handling The PROXY protocol as defined by HAProxy.</p>
<p>Supports versions:</p><ul>
<li>1</li>
<li>2</li>
</ul>
<p>Source is the client connecting to the system (Client). Destination is the server accepting the connection which will then relay using proxy protocol (proxy server). There can be multiple proxies in a chain between the source and the final server that is going to process the data. A such the destination address may not be the connection address for the final server's connection.</p>
<h1><a class="anchor" id="autotoc_md72"></a>
Examples</h1>
<h2><a class="anchor" id="autotoc_md73"></a>
Proxy Server</h2>
<p>This server accepts inbound connections, and sends the data to another system using the proxy protocol. The inbound client is not using proxy protocol. The server the proxy is relaying the data to is using proxy protocol.</p>
<p><code>client &lt;-&gt; proxy server example (sends proxy protocol) &lt;-&gt; final server (receives proxy protocol)</code></p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;mstdlib/mstdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;mstdlib/mstdlib_io.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <a class="code" href="group__m__buf.html#ga6c543ecf0004fc310faa23c6ed8b267f">M_buf_t</a>   *source_to_dest_buf;</div>
<div class="line">    <a class="code" href="group__m__buf.html#ga6c543ecf0004fc310faa23c6ed8b267f">M_buf_t</a>   *dest_to_source_buf;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>    *source_io;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>    *dest_io;</div>
<div class="line">} ldata_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__m__dns.html#ga6d7651186321b1cc222aa53bd0fa3d22">M_dns_t</a> *dns;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> destination_cb(<a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a> *el, <a class="code" href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a> etype, <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, <span class="keywordtype">void</span> *thunk)</div>
<div class="line">{</div>
<div class="line">    ldata_t *ldata      = thunk;</div>
<div class="line">    <span class="keywordtype">char</span>     error[256] = { 0 };</div>
<div class="line">    M_bool   clean      = M_FALSE;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (etype) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2">M_EVENT_TYPE_CONNECTED</a>:</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;CONNECTED TO SERVER: %s%s%s:%d\n&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426">M_EVENT_TYPE_READ</a>:</div>
<div class="line">            <a class="code" href="group__m__io.html#ga169a51aae28306fe85b41d9063c83d43">M_io_read_into_buf</a>(io, ldata-&gt;dest_to_source_buf);</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__m__buf.html#gaaff39362df33795d6c188ca3482a12cd">M_buf_len</a>(ldata-&gt;dest_to_source_buf) &gt; 0) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a>(ldata-&gt;source_io, ldata-&gt;dest_to_source_buf);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9">M_EVENT_TYPE_WRITE</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__m__buf.html#gaaff39362df33795d6c188ca3482a12cd">M_buf_len</a>(ldata-&gt;source_to_dest_buf) &gt; 0) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a>(io, ldata-&gt;source_to_dest_buf);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0">M_EVENT_TYPE_ACCEPT</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac">M_EVENT_TYPE_ERROR</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf">M_EVENT_TYPE_OTHER</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (etype == <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>) {</div>
<div class="line">                clean = M_TRUE;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga3e1f56ec1e586649c1b26eb7c72238de">M_io_get_error_string</a>(io, error, <span class="keyword">sizeof</span>(error));</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;SERVER %s: %s%s%s:%d (%s%s%s)\n&quot;</span>,</div>
<div class="line">                    etype == <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a> ? <span class="stringliteral">&quot;DISCONNECTED&quot;</span> : <span class="stringliteral">&quot;ABORT&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io),</div>
<div class="line">                    clean?<span class="stringliteral">&quot;clean&quot;</span>:<span class="stringliteral">&quot;unclean&quot;</span>, clean?<span class="stringliteral">&quot;&quot;</span>:<span class="stringliteral">&quot; - &quot;</span>, clean?<span class="stringliteral">&quot;&quot;</span>:error);</div>
<div class="line"> </div>
<div class="line">            <a class="code" href="group__m__io.html#ga02a1aa7eee8d2fb2e7fdc189f33e649e">M_io_disconnect</a>(ldata-&gt;source_io);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> source_cb(<a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a> *el, <a class="code" href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a> etype, <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, <span class="keywordtype">void</span> *thunk)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>                   *io_out     = NULL;</div>
<div class="line">    ldata_t                  *ldata      = thunk;</div>
<div class="line">    <span class="keywordtype">char</span>                      error[256] = { 0 };</div>
<div class="line">    M_bool                    clean      = M_FALSE;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>              ioerr;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (etype) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2">M_EVENT_TYPE_CONNECTED</a>:</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;CLIENT CONNECTED: %s%s%s:%d\n&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io));</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Create a connetion to the destination echo server.</span></div>
<div class="line">            ioerr = <a class="code" href="group__m__io__net.html#ga9c11a4575c3389ee8d11b6f084e257bd">M_io_net_client_create</a>(&amp;io_out, dns, <span class="stringliteral">&quot;localhost&quot;</span>, 8999, <a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea5f95bd5b48dcaf1f1d5e911c8bba2d32">M_IO_NET_ANY</a>);</div>
<div class="line">            <span class="keywordflow">if</span> (ioerr != <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a>) {</div>
<div class="line">                <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;Could not create client: %s\n&quot;</span>, <a class="code" href="group__m__io.html#ga89a45c257b8b62345c2bc035da6cc4d0">M_io_error_string</a>(ioerr));</div>
<div class="line">                <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io);</div>
<div class="line">            }</div>
<div class="line">            <span class="comment">// Add the proxy protocol to the destination connection so the</span></div>
<div class="line">             <span class="comment">// source information will be relayed to the echo server.</span></div>
<div class="line">            <a class="code" href="group__m__io__proxy__protocol.html#gaa6382c849d8aeda4b03d365c6f811a60">M_io_proxy_protocol_outbound_add</a>(io_out, NULL, <a class="code" href="group__m__io__proxy__protocol.html#gga07c46f091a99fdaac9e9bd23c599d67fa5bbdffd4b22645f75bd0cb9510fe50c8">M_IO_PROXY_PROTOCOL_FLAG_NONE</a>);</div>
<div class="line">            <a class="code" href="group__m__io__proxy__protocol.html#ga263a6cac977efe462bb133a1a562a7c6">M_io_proxy_protocol_set_source_endpoints</a>(io_out, <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io), <a class="code" href="group__m__io__net.html#ga9c00804a3f50b3cc60c4aa245b2a377c">M_io_net_get_server_ipaddr</a>(io), <a class="code" href="group__m__io__net.html#ga9b5c7120aabf48773a689e3b17ddf33b">M_io_net_get_ephemeral_port</a>(io), <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io));</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// Store the echo server&#39;s io object so we can communicate with it.</span></div>
<div class="line">            ldata-&gt;dest_io = io_out;</div>
<div class="line"> </div>
<div class="line">            <a class="code" href="group__m__event.html#ga755cf00991529e324be3f9f49a5d5476">M_event_add</a>(el, io_out, destination_cb, ldata);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426">M_EVENT_TYPE_READ</a>:</div>
<div class="line">            <a class="code" href="group__m__io.html#ga169a51aae28306fe85b41d9063c83d43">M_io_read_into_buf</a>(io, ldata-&gt;source_to_dest_buf);</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__m__buf.html#gaaff39362df33795d6c188ca3482a12cd">M_buf_len</a>(ldata-&gt;source_to_dest_buf) &gt; 0) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a>(ldata-&gt;dest_io, ldata-&gt;source_to_dest_buf);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9">M_EVENT_TYPE_WRITE</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__m__buf.html#gaaff39362df33795d6c188ca3482a12cd">M_buf_len</a>(ldata-&gt;dest_to_source_buf) &gt; 0) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a>(io, ldata-&gt;dest_to_source_buf);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0">M_EVENT_TYPE_ACCEPT</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac">M_EVENT_TYPE_ERROR</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf">M_EVENT_TYPE_OTHER</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (etype == <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>) {</div>
<div class="line">                clean = M_TRUE;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga3e1f56ec1e586649c1b26eb7c72238de">M_io_get_error_string</a>(io, error, <span class="keyword">sizeof</span>(error));</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;CLIENT %s: %s%s%s:%d (%s%s%s)\n&quot;</span>,</div>
<div class="line">                    etype == <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a> ? <span class="stringliteral">&quot;DISCONNECTED&quot;</span> : <span class="stringliteral">&quot;ABORT&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io),</div>
<div class="line">                    clean?<span class="stringliteral">&quot;clean&quot;</span>:<span class="stringliteral">&quot;unclean&quot;</span>, clean?<span class="stringliteral">&quot;&quot;</span>:<span class="stringliteral">&quot; - &quot;</span>, clean?<span class="stringliteral">&quot;&quot;</span>:error);</div>
<div class="line"> </div>
<div class="line">            <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(ldata-&gt;dest_io);</div>
<div class="line">            <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io);</div>
<div class="line">            <a class="code" href="group__m__buf.html#gad51baebd5e46ee8231e78b926ccb198e">M_buf_cancel</a>(ldata-&gt;source_to_dest_buf);</div>
<div class="line">            <a class="code" href="group__m__buf.html#gad51baebd5e46ee8231e78b926ccb198e">M_buf_cancel</a>(ldata-&gt;dest_to_source_buf);</div>
<div class="line">            <a class="code" href="group__m__mem.html#gac4b3c1d73d6efe2542f5e729b58a271d">M_free</a>(ldata);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> source_listen_cb(<a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a> *el, <a class="code" href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a> etype, <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, <span class="keywordtype">void</span> *thunk)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>       *io_out     = NULL;</div>
<div class="line">    ldata_t      *ldata;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>  ioerr;</div>
<div class="line">    <span class="keywordtype">char</span>          error[256] = { 0 };</div>
<div class="line"> </div>
<div class="line">    (void)thunk;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (etype) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0">M_EVENT_TYPE_ACCEPT</a>:</div>
<div class="line">            <span class="comment">// Accept connection form source and create an io object to communicate with it.</span></div>
<div class="line">            ioerr = <a class="code" href="group__m__io.html#ga71d86bb1d3ea521f64005e7d31f90909">M_io_accept</a>(&amp;io_out, io);</div>
<div class="line">            <span class="keywordflow">if</span> (ioerr == <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2ace85a86b9ab6805d5838754b4c111c">M_IO_ERROR_WOULDBLOCK</a>) {</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioerr != <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a> || io_out == NULL) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga3e1f56ec1e586649c1b26eb7c72238de">M_io_get_error_string</a>(io, error, <span class="keyword">sizeof</span>(error));</div>
<div class="line">                <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;ACCEPT FAILURE: %s\n&quot;</span>, error);</div>
<div class="line">                <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io_out);</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            ldata                     = <a class="code" href="group__m__mem.html#ga9473a8ef59f5c85d37b3d35f461a82f1">M_malloc_zero</a>(<span class="keyword">sizeof</span>(*ldata));</div>
<div class="line">            ldata-&gt;source_to_dest_buf = <a class="code" href="group__m__buf.html#ga2031dcfdfa76f5feb5a59c8e7ac155d0">M_buf_create</a>();</div>
<div class="line">            ldata-&gt;dest_to_source_buf = <a class="code" href="group__m__buf.html#ga2031dcfdfa76f5feb5a59c8e7ac155d0">M_buf_create</a>();</div>
<div class="line">            ldata-&gt;source_io          = io_out;</div>
<div class="line"> </div>
<div class="line">            <a class="code" href="group__m__event.html#ga755cf00991529e324be3f9f49a5d5476">M_event_add</a>(el, io_out, source_cb, ldata);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2">M_EVENT_TYPE_CONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426">M_EVENT_TYPE_READ</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9">M_EVENT_TYPE_WRITE</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac">M_EVENT_TYPE_ERROR</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf">M_EVENT_TYPE_OTHER</a>:</div>
<div class="line">            <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a>    *el;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>       *io_source = NULL;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>  ioerr;</div>
<div class="line"> </div>
<div class="line">    dns = <a class="code" href="group__m__dns.html#ga5175216540121322108fc571d5206ca7">M_dns_create</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Setup our listening server which will listen for source connections.</span></div>
<div class="line">    ioerr = <a class="code" href="group__m__io__net.html#gabb60697b08a7ee07079ea683a1060747">M_io_net_server_create</a>(&amp;io_source, 8998, NULL, <a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea5f95bd5b48dcaf1f1d5e911c8bba2d32">M_IO_NET_ANY</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (ioerr != <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a>) {</div>
<div class="line">        <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;Could not start server: %s\n&quot;</span>, <a class="code" href="group__m__io.html#ga89a45c257b8b62345c2bc035da6cc4d0">M_io_error_string</a>(ioerr));</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    el = <a class="code" href="group__m__event.html#gae169dca80125767d87fe196f32ea8d74">M_event_create</a>(<a class="code" href="group__m__event.html#gga72bc04891ff7b6142b7672a207ae74b1ac7efcb61cf28fa27d4a0a3daf68aaecf">M_EVENT_FLAG_NONE</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__m__event.html#ga755cf00991529e324be3f9f49a5d5476">M_event_add</a>(el, io_source, source_listen_cb, NULL);</div>
<div class="line">    <a class="code" href="group__m__event.html#gab5e0ea9055833a684aee9587252ed5fd">M_event_loop</a>(el, M_TIMEOUT_INF);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__m__event.html#ga603f06976101b21e00517deb529f86bb">M_event_destroy</a>(el);</div>
<div class="line">    <a class="code" href="group__m__dns.html#ga242ac37ba5fc0ad26dae4cc53553092a">M_dns_destroy</a>(dns);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__m__buf_html_ga2031dcfdfa76f5feb5a59c8e7ac155d0"><div class="ttname"><a href="group__m__buf.html#ga2031dcfdfa76f5feb5a59c8e7ac155d0">M_buf_create</a></div><div class="ttdeci">M_buf_t * M_buf_create(void) M_WARN_UNUSED_RESULT M_MALLOC</div></div>
<div class="ttc" id="agroup__m__buf_html_ga6c543ecf0004fc310faa23c6ed8b267f"><div class="ttname"><a href="group__m__buf.html#ga6c543ecf0004fc310faa23c6ed8b267f">M_buf_t</a></div><div class="ttdeci">struct M_buf M_buf_t</div><div class="ttdef"><b>Definition:</b> m_buf.h:77</div></div>
<div class="ttc" id="agroup__m__buf_html_gaaff39362df33795d6c188ca3482a12cd"><div class="ttname"><a href="group__m__buf.html#gaaff39362df33795d6c188ca3482a12cd">M_buf_len</a></div><div class="ttdeci">size_t M_buf_len(const M_buf_t *buf)</div></div>
<div class="ttc" id="agroup__m__buf_html_gad51baebd5e46ee8231e78b926ccb198e"><div class="ttname"><a href="group__m__buf.html#gad51baebd5e46ee8231e78b926ccb198e">M_buf_cancel</a></div><div class="ttdeci">void M_buf_cancel(M_buf_t *buf) M_FREE(1)</div></div>
<div class="ttc" id="agroup__m__dns_html_ga242ac37ba5fc0ad26dae4cc53553092a"><div class="ttname"><a href="group__m__dns.html#ga242ac37ba5fc0ad26dae4cc53553092a">M_dns_destroy</a></div><div class="ttdeci">M_bool M_dns_destroy(M_dns_t *dns)</div></div>
<div class="ttc" id="agroup__m__dns_html_ga5175216540121322108fc571d5206ca7"><div class="ttname"><a href="group__m__dns.html#ga5175216540121322108fc571d5206ca7">M_dns_create</a></div><div class="ttdeci">M_dns_t * M_dns_create(M_event_t *event)</div></div>
<div class="ttc" id="agroup__m__dns_html_ga6d7651186321b1cc222aa53bd0fa3d22"><div class="ttname"><a href="group__m__dns.html#ga6d7651186321b1cc222aa53bd0fa3d22">M_dns_t</a></div><div class="ttdeci">struct M_dns M_dns_t</div><div class="ttdef"><b>Definition:</b> m_dns.h:43</div></div>
<div class="ttc" id="agroup__m__event_html_ga603f06976101b21e00517deb529f86bb"><div class="ttname"><a href="group__m__event.html#ga603f06976101b21e00517deb529f86bb">M_event_destroy</a></div><div class="ttdeci">void M_event_destroy(M_event_t *event)</div></div>
<div class="ttc" id="agroup__m__event_html_ga66b039653a61c8702310d03e6ba69802"><div class="ttname"><a href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a></div><div class="ttdeci">enum M_event_type M_event_type_t</div><div class="ttdef"><b>Definition:</b> m_event.h:189</div></div>
<div class="ttc" id="agroup__m__event_html_ga747f0301bfcc6db3b51eaf07e2582350"><div class="ttname"><a href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a></div><div class="ttdeci">struct M_event M_event_t</div><div class="ttdef"><b>Definition:</b> m_event.h:210</div></div>
<div class="ttc" id="agroup__m__event_html_ga755cf00991529e324be3f9f49a5d5476"><div class="ttname"><a href="group__m__event.html#ga755cf00991529e324be3f9f49a5d5476">M_event_add</a></div><div class="ttdeci">M_bool M_event_add(M_event_t *event, M_io_t *io, M_event_callback_t callback, void *cb_data)</div></div>
<div class="ttc" id="agroup__m__event_html_gab5e0ea9055833a684aee9587252ed5fd"><div class="ttname"><a href="group__m__event.html#gab5e0ea9055833a684aee9587252ed5fd">M_event_loop</a></div><div class="ttdeci">M_event_err_t M_event_loop(M_event_t *event, M_uint64 timeout_ms)</div></div>
<div class="ttc" id="agroup__m__event_html_gae169dca80125767d87fe196f32ea8d74"><div class="ttname"><a href="group__m__event.html#gae169dca80125767d87fe196f32ea8d74">M_event_create</a></div><div class="ttdeci">M_event_t * M_event_create(M_uint32 flags)</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9">M_EVENT_TYPE_WRITE</a></div><div class="ttdeci">@ M_EVENT_TYPE_WRITE</div><div class="ttdef"><b>Definition:</b> m_event.h:184</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0">M_EVENT_TYPE_ACCEPT</a></div><div class="ttdeci">@ M_EVENT_TYPE_ACCEPT</div><div class="ttdef"><b>Definition:</b> m_event.h:174</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a></div><div class="ttdeci">@ M_EVENT_TYPE_DISCONNECTED</div><div class="ttdef"><b>Definition:</b> m_event.h:176</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf">M_EVENT_TYPE_OTHER</a></div><div class="ttdeci">@ M_EVENT_TYPE_OTHER</div><div class="ttdef"><b>Definition:</b> m_event.h:185</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426">M_EVENT_TYPE_READ</a></div><div class="ttdeci">@ M_EVENT_TYPE_READ</div><div class="ttdef"><b>Definition:</b> m_event.h:175</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2">M_EVENT_TYPE_CONNECTED</a></div><div class="ttdeci">@ M_EVENT_TYPE_CONNECTED</div><div class="ttdef"><b>Definition:</b> m_event.h:173</div></div>
<div class="ttc" id="agroup__m__event_html_gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac"><div class="ttname"><a href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac">M_EVENT_TYPE_ERROR</a></div><div class="ttdeci">@ M_EVENT_TYPE_ERROR</div><div class="ttdef"><b>Definition:</b> m_event.h:181</div></div>
<div class="ttc" id="agroup__m__event_html_gga72bc04891ff7b6142b7672a207ae74b1ac7efcb61cf28fa27d4a0a3daf68aaecf"><div class="ttname"><a href="group__m__event.html#gga72bc04891ff7b6142b7672a207ae74b1ac7efcb61cf28fa27d4a0a3daf68aaecf">M_EVENT_FLAG_NONE</a></div><div class="ttdeci">@ M_EVENT_FLAG_NONE</div><div class="ttdef"><b>Definition:</b> m_event.h:232</div></div>
<div class="ttc" id="agroup__m__fmt_html_gae54b252ea2bcf34b09ef1fa0f134ffa8"><div class="ttname"><a href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a></div><div class="ttdeci">ssize_t M_printf(const char *fmt,...)</div></div>
<div class="ttc" id="agroup__m__io__net_html_ga11f193aa2d827dcd1faf26dd20a3d2a0"><div class="ttname"><a href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a></div><div class="ttdeci">const char * M_io_net_get_ipaddr(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__net_html_ga1ea4d8faa134421ebe9765d2c60e032a"><div class="ttname"><a href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a></div><div class="ttdeci">unsigned short M_io_net_get_port(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__net_html_ga79dfed55a6ba8ccf55d1cef9fc89f8c3"><div class="ttname"><a href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a></div><div class="ttdeci">enum M_io_net_type M_io_net_get_type(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__net_html_ga9b5c7120aabf48773a689e3b17ddf33b"><div class="ttname"><a href="group__m__io__net.html#ga9b5c7120aabf48773a689e3b17ddf33b">M_io_net_get_ephemeral_port</a></div><div class="ttdeci">unsigned short M_io_net_get_ephemeral_port(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__net_html_ga9c00804a3f50b3cc60c4aa245b2a377c"><div class="ttname"><a href="group__m__io__net.html#ga9c00804a3f50b3cc60c4aa245b2a377c">M_io_net_get_server_ipaddr</a></div><div class="ttdeci">const char * M_io_net_get_server_ipaddr(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__net_html_ga9c11a4575c3389ee8d11b6f084e257bd"><div class="ttname"><a href="group__m__io__net.html#ga9c11a4575c3389ee8d11b6f084e257bd">M_io_net_client_create</a></div><div class="ttdeci">M_io_error_t M_io_net_client_create(M_io_t **io_out, M_dns_t *dns, const char *host, unsigned short port, M_io_net_type_t type)</div></div>
<div class="ttc" id="agroup__m__io__net_html_gabb60697b08a7ee07079ea683a1060747"><div class="ttname"><a href="group__m__io__net.html#gabb60697b08a7ee07079ea683a1060747">M_io_net_server_create</a></div><div class="ttdeci">M_io_error_t M_io_net_server_create(M_io_t **io_out, unsigned short port, const char *bind_ip, M_io_net_type_t type)</div></div>
<div class="ttc" id="agroup__m__io__net_html_gga84d77b37b252e30d90cc6fd2a416267ea5f95bd5b48dcaf1f1d5e911c8bba2d32"><div class="ttname"><a href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea5f95bd5b48dcaf1f1d5e911c8bba2d32">M_IO_NET_ANY</a></div><div class="ttdeci">@ M_IO_NET_ANY</div><div class="ttdef"><b>Definition:</b> m_io_net.h:336</div></div>
<div class="ttc" id="agroup__m__io__net_html_gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd"><div class="ttname"><a href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a></div><div class="ttdeci">@ M_IO_NET_IPV6</div><div class="ttdef"><b>Definition:</b> m_io_net.h:338</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_ga263a6cac977efe462bb133a1a562a7c6"><div class="ttname"><a href="group__m__io__proxy__protocol.html#ga263a6cac977efe462bb133a1a562a7c6">M_io_proxy_protocol_set_source_endpoints</a></div><div class="ttdeci">M_bool M_io_proxy_protocol_set_source_endpoints(M_io_t *io, const char *source_ipaddr, const char *dest_ipaddr, M_uint16 source_port, M_uint16 dest_port)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_gaa6382c849d8aeda4b03d365c6f811a60"><div class="ttname"><a href="group__m__io__proxy__protocol.html#gaa6382c849d8aeda4b03d365c6f811a60">M_io_proxy_protocol_outbound_add</a></div><div class="ttdeci">M_io_error_t M_io_proxy_protocol_outbound_add(M_io_t *io, size_t *layer_id, M_uint32 flags)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_gga07c46f091a99fdaac9e9bd23c599d67fa5bbdffd4b22645f75bd0cb9510fe50c8"><div class="ttname"><a href="group__m__io__proxy__protocol.html#gga07c46f091a99fdaac9e9bd23c599d67fa5bbdffd4b22645f75bd0cb9510fe50c8">M_IO_PROXY_PROTOCOL_FLAG_NONE</a></div><div class="ttdeci">@ M_IO_PROXY_PROTOCOL_FLAG_NONE</div><div class="ttdef"><b>Definition:</b> m_io_proxy_protocol.h:511</div></div>
<div class="ttc" id="agroup__m__io_html_ga02a1aa7eee8d2fb2e7fdc189f33e649e"><div class="ttname"><a href="group__m__io.html#ga02a1aa7eee8d2fb2e7fdc189f33e649e">M_io_disconnect</a></div><div class="ttdeci">void M_io_disconnect(M_io_t *comm)</div></div>
<div class="ttc" id="agroup__m__io_html_ga1532f13c1f01fc1521b68a0f1d61c864"><div class="ttname"><a href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a></div><div class="ttdeci">void M_io_destroy(M_io_t *comm)</div></div>
<div class="ttc" id="agroup__m__io_html_ga169a51aae28306fe85b41d9063c83d43"><div class="ttname"><a href="group__m__io.html#ga169a51aae28306fe85b41d9063c83d43">M_io_read_into_buf</a></div><div class="ttdeci">M_io_error_t M_io_read_into_buf(M_io_t *comm, M_buf_t *buf)</div></div>
<div class="ttc" id="agroup__m__io_html_ga2d3bea9aaa4491c3c8dad94cf24498a2"><div class="ttname"><a href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a></div><div class="ttdeci">enum M_io_error M_io_error_t</div><div class="ttdef"><b>Definition:</b> m_io.h:93</div></div>
<div class="ttc" id="agroup__m__io_html_ga3e1f56ec1e586649c1b26eb7c72238de"><div class="ttname"><a href="group__m__io.html#ga3e1f56ec1e586649c1b26eb7c72238de">M_io_get_error_string</a></div><div class="ttdeci">void M_io_get_error_string(M_io_t *io, char *error, size_t err_len)</div></div>
<div class="ttc" id="agroup__m__io_html_ga71d86bb1d3ea521f64005e7d31f90909"><div class="ttname"><a href="group__m__io.html#ga71d86bb1d3ea521f64005e7d31f90909">M_io_accept</a></div><div class="ttdeci">M_io_error_t M_io_accept(M_io_t **io_out, M_io_t *server_io)</div></div>
<div class="ttc" id="agroup__m__io_html_ga845c131d8520206a2a7a9219d1bd1932"><div class="ttname"><a href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a></div><div class="ttdeci">struct M_io M_io_t</div><div class="ttdef"><b>Definition:</b> m_io.h:59</div></div>
<div class="ttc" id="agroup__m__io_html_ga89a45c257b8b62345c2bc035da6cc4d0"><div class="ttname"><a href="group__m__io.html#ga89a45c257b8b62345c2bc035da6cc4d0">M_io_error_string</a></div><div class="ttdeci">const char * M_io_error_string(M_io_error_t error)</div></div>
<div class="ttc" id="agroup__m__io_html_ga957eba52f32304ab07e06b516c04922a"><div class="ttname"><a href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a></div><div class="ttdeci">M_io_error_t M_io_write_from_buf(M_io_t *comm, M_buf_t *buf)</div></div>
<div class="ttc" id="agroup__m__io_html_gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30"><div class="ttname"><a href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a></div><div class="ttdeci">@ M_IO_ERROR_SUCCESS</div><div class="ttdef"><b>Definition:</b> m_io.h:69</div></div>
<div class="ttc" id="agroup__m__io_html_gga1ea9e3c1babf09b22f2b98899db790dba2ace85a86b9ab6805d5838754b4c111c"><div class="ttname"><a href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2ace85a86b9ab6805d5838754b4c111c">M_IO_ERROR_WOULDBLOCK</a></div><div class="ttdeci">@ M_IO_ERROR_WOULDBLOCK</div><div class="ttdef"><b>Definition:</b> m_io.h:70</div></div>
<div class="ttc" id="agroup__m__mem_html_ga9473a8ef59f5c85d37b3d35f461a82f1"><div class="ttname"><a href="group__m__mem.html#ga9473a8ef59f5c85d37b3d35f461a82f1">M_malloc_zero</a></div><div class="ttdeci">void * M_malloc_zero(size_t size) M_ALLOC_SIZE(1) M_WARN_UNUSED_RESULT M_MALLOC</div></div>
<div class="ttc" id="agroup__m__mem_html_gac4b3c1d73d6efe2542f5e729b58a271d"><div class="ttname"><a href="group__m__mem.html#gac4b3c1d73d6efe2542f5e729b58a271d">M_free</a></div><div class="ttdeci">void M_free(void *ptr) M_FREE(1)</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md74"></a>
Echo Server (accepting proxy protocol)</h2>
<p>This is a basic echo server where any data received is echoed back out. The server only accepts connections that use proxy protocol.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;mstdlib/mstdlib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;mstdlib/mstdlib_io.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Echo server states.</span></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> {</div>
<div class="line">    STATE_CHECK = 1,</div>
<div class="line">    STATE_ECHO,</div>
<div class="line">    STATE_EXIT</div>
<div class="line">} states_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{</div>
<div class="line">    <a class="code" href="group__m__buf.html#ga6c543ecf0004fc310faa23c6ed8b267f">M_buf_t</a>           *write_buf;</div>
<div class="line">    <a class="code" href="group__m__parser.html#ga60164be64f8c962c795e5927642fc473">M_parser_t</a>        *read_parser;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>            *io;</div>
<div class="line">    <a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a>         *el;</div>
<div class="line">    <a class="code" href="group__m__state__machine.html#gad576e0cce8ea03b5bfcffabfacfe6c14">M_state_machine_t</a> *sm;</div>
<div class="line">} ldata_t;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> do_trace(<span class="keywordtype">void</span> *cb_arg, <a class="code" href="group__m__io__trace.html#ga9de6468f493c8465ee53389d50c1dc87">M_io_trace_type_t</a> type, <a class="code" href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a> event_type, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> data_len)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">char</span> *out;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (type) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__io__trace.html#gga906c49459ff07273bc2111733993ed69a08ed08ce37e683a12bf3a77dd62c468d">M_IO_TRACE_TYPE_READ</a>:</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;READ:\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__io__trace.html#gga906c49459ff07273bc2111733993ed69a8156a9773735d37f3d4baf2446315f16">M_IO_TRACE_TYPE_WRITE</a>:</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;WRITE:\n&quot;</span>);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">    out = <a class="code" href="group__m__str__convert.html#ga92578e5f93242d414f9042c3d23ac7cb">M_str_hexdump</a>(<a class="code" href="group__m__str__convert.html#gga91fbd8e7976f8f06d8f54048585159efa58a3973b16170409c0588113d7ba4518">M_STR_HEXDUMP_HEADER</a>, 0, <span class="stringliteral">&quot;\t&quot;</span>, data, data_len);</div>
<div class="line">    <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;%s\n&quot;</span>, out);</div>
<div class="line">    <a class="code" href="group__m__mem.html#gac4b3c1d73d6efe2542f5e729b58a271d">M_free</a>(out);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__m__state__machine.html#gac270a27ce03a23e30d86788b2103268b">M_state_machine_status_t</a> state_check(<span class="keywordtype">void</span> *data, M_uint64 *next)</div>
<div class="line">{</div>
<div class="line">    ldata_t *ldata = data;</div>
<div class="line"> </div>
<div class="line">    (void)next;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Check for new line which indicates full message to echo.</span></div>
<div class="line">    <a class="code" href="group__m__parser.html#gad2f6bcc3999859f9bfabce4679697d30">M_parser_mark</a>(ldata-&gt;read_parser);</div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code" href="group__m__parser.html#gafeb4f3232d2d842889823bdf70338ac6">M_parser_len</a>(ldata-&gt;read_parser) == 0 || <a class="code" href="group__m__parser.html#gae09ef7f274b45bbe005bb7f0d96ae011">M_parser_consume_until</a>(ldata-&gt;read_parser, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;\n&quot;</span>, 1, M_TRUE) == 0) {</div>
<div class="line">        <a class="code" href="group__m__parser.html#gab56a859c33b45f16a1af4134a502fc6c">M_parser_mark_rewind</a>(ldata-&gt;read_parser);</div>
<div class="line">        <span class="keywordflow">return</span> <a class="code" href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba268c02ad158bd9a779c2a1226704a672">M_STATE_MACHINE_STATUS_WAIT</a>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba99a33d04268a2612969eaf95a66aaa55">M_STATE_MACHINE_STATUS_NEXT</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__m__state__machine.html#gac270a27ce03a23e30d86788b2103268b">M_state_machine_status_t</a> state_echo(<span class="keywordtype">void</span> *data, M_uint64 *next)</div>
<div class="line">{</div>
<div class="line">    ldata_t *ldata = data;</div>
<div class="line">    <span class="keywordtype">char</span>    *out;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Echo the data.</span></div>
<div class="line">    out = <a class="code" href="group__m__parser.html#ga0d79542fe6a498f071bbcc8fcb081949">M_parser_read_strdup_mark</a>(ldata-&gt;read_parser);</div>
<div class="line">    <a class="code" href="group__m__buf.html#gad226a7199f864ff6a630dc7f16508c30">M_buf_add_str</a>(ldata-&gt;write_buf, out);</div>
<div class="line">    <a class="code" href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a>(ldata-&gt;io, ldata-&gt;write_buf);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Check for exit command.</span></div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="group__m__str__check.html#ga5470a5985b0adb95aff5fc53780be8c7">M_str_eq</a>(out, <span class="stringliteral">&quot;EXIT\r\n&quot;</span>) &amp;&amp; !<a class="code" href="group__m__str__check.html#ga5470a5985b0adb95aff5fc53780be8c7">M_str_eq</a>(out, <span class="stringliteral">&quot;EXIT\n&quot;</span>))</div>
<div class="line">        *next = STATE_CHECK;</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__m__mem.html#gac4b3c1d73d6efe2542f5e729b58a271d">M_free</a>(out);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba99a33d04268a2612969eaf95a66aaa55">M_STATE_MACHINE_STATUS_NEXT</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <a class="code" href="group__m__state__machine.html#gac270a27ce03a23e30d86788b2103268b">M_state_machine_status_t</a> state_exit(<span class="keywordtype">void</span> *data, M_uint64 *next)</div>
<div class="line">{</div>
<div class="line">    ldata_t *ldata = data;</div>
<div class="line">    (void)next;</div>
<div class="line">    <span class="comment">// Exit the server.</span></div>
<div class="line">    <a class="code" href="group__m__event.html#gaf1b183d71c9f577e0779e9f44eb06896">M_event_done_with_disconnect</a>(ldata-&gt;el, 0, 1000);</div>
<div class="line">    <span class="keywordflow">return</span> <a class="code" href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba99a33d04268a2612969eaf95a66aaa55">M_STATE_MACHINE_STATUS_NEXT</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> connection_cb(<a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a> *el, <a class="code" href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a> etype, <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, <span class="keywordtype">void</span> *thunk)</div>
<div class="line">{</div>
<div class="line">    ldata_t                  *ldata      = thunk;</div>
<div class="line">    <span class="keywordtype">char</span>                      error[256] = { 0 };</div>
<div class="line">    M_bool                    clean      = M_FALSE;</div>
<div class="line">    <a class="code" href="group__m__state__machine.html#gac270a27ce03a23e30d86788b2103268b">M_state_machine_status_t</a>  status;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (etype) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2">M_EVENT_TYPE_CONNECTED</a>:</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;CLIENT CONNECTED: %s%s%s:%d\n&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io));</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;SERVER IP: %s%s%s\n&quot;</span>, </div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga9c00804a3f50b3cc60c4aa245b2a377c">M_io_net_get_server_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;PROXYED SOURCE: %s%s%s:%d\n&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#ga4721163ab454a575722f3fd628702b71">M_io_proxy_protocol_proxied_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#ga4bb6960e44981297a6a01348252327e5">M_io_proxy_protocol_source_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#ga4721163ab454a575722f3fd628702b71">M_io_proxy_protocol_proxied_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#gad8431b167cf43e4f48690ab943272cab">M_io_proxy_protocol_source_port</a>(io));</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;PROXYED DEST: %s%s%s:%d\n&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#ga4721163ab454a575722f3fd628702b71">M_io_proxy_protocol_proxied_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#gaeef527389ce51d5bfc88abf50cde416b">M_io_proxy_protocol_dest_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#ga4721163ab454a575722f3fd628702b71">M_io_proxy_protocol_proxied_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__proxy__protocol.html#gaa24ad926cb118e7260ebb5e26c8057b2">M_io_proxy_protocol_dest_port</a>(io));</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426">M_EVENT_TYPE_READ</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__m__io.html#ga0fb4e2775a964a263f7ec0fa50be4023">M_io_read_into_parser</a>(io, ldata-&gt;read_parser) == <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a>) {</div>
<div class="line">                status = <a class="code" href="group__m__state__machine.html#ga5907f72a878c13dd0517d874af6dfd5f">M_state_machine_run</a>(ldata-&gt;sm, ldata);</div>
<div class="line">                <span class="keywordflow">if</span> (status != <a class="code" href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba268c02ad158bd9a779c2a1226704a672">M_STATE_MACHINE_STATUS_WAIT</a>) {</div>
<div class="line">                    <a class="code" href="group__m__io.html#ga02a1aa7eee8d2fb2e7fdc189f33e649e">M_io_disconnect</a>(io);</div>
<div class="line">                }</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9">M_EVENT_TYPE_WRITE</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (<a class="code" href="group__m__buf.html#gaaff39362df33795d6c188ca3482a12cd">M_buf_len</a>(ldata-&gt;write_buf) &gt; 0) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga957eba52f32304ab07e06b516c04922a">M_io_write_from_buf</a>(io, ldata-&gt;write_buf);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0">M_EVENT_TYPE_ACCEPT</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac">M_EVENT_TYPE_ERROR</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf">M_EVENT_TYPE_OTHER</a>:</div>
<div class="line">            <span class="keywordflow">if</span> (etype == <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>) {</div>
<div class="line">                clean = M_TRUE;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga3e1f56ec1e586649c1b26eb7c72238de">M_io_get_error_string</a>(io, error, <span class="keyword">sizeof</span>(error));</div>
<div class="line">            }</div>
<div class="line">            <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;CLIENT %s: %s%s%s:%d (%s%s%s)\n&quot;</span>,</div>
<div class="line">                    etype == <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a> ? <span class="stringliteral">&quot;DISCONNECTED&quot;</span> : <span class="stringliteral">&quot;ABORT&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;[&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io),</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga79dfed55a6ba8ccf55d1cef9fc89f8c3">M_io_net_get_type</a>(io)==<a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea8c2d3e438709058e8f0cdebbb6279bdd">M_IO_NET_IPV6</a>?<span class="stringliteral">&quot;]&quot;</span>:<span class="stringliteral">&quot;&quot;</span>,</div>
<div class="line">                    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io),</div>
<div class="line">                    clean?<span class="stringliteral">&quot;clean&quot;</span>:<span class="stringliteral">&quot;unclean&quot;</span>, clean?<span class="stringliteral">&quot;&quot;</span>:<span class="stringliteral">&quot; - &quot;</span>, clean?<span class="stringliteral">&quot;&quot;</span>:error);</div>
<div class="line"> </div>
<div class="line">            <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io);</div>
<div class="line">            <a class="code" href="group__m__state__machine.html#gaff67fd829b43aabe519c004d44cd0211">M_state_machine_destroy</a>(ldata-&gt;sm);</div>
<div class="line">            <a class="code" href="group__m__buf.html#gad51baebd5e46ee8231e78b926ccb198e">M_buf_cancel</a>(ldata-&gt;write_buf);</div>
<div class="line">            <a class="code" href="group__m__parser.html#ga3cd7b444d6f5058b149bc4c7262d5cb7">M_parser_destroy</a>(ldata-&gt;read_parser);</div>
<div class="line">            <a class="code" href="group__m__mem.html#gac4b3c1d73d6efe2542f5e729b58a271d">M_free</a>(ldata);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> listen_cb(<a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a> *el, <a class="code" href="group__m__event.html#ga66b039653a61c8702310d03e6ba69802">M_event_type_t</a> etype, <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *io, <span class="keywordtype">void</span> *thunk)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>       *io_out     = NULL;</div>
<div class="line">    ldata_t      *ldata;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>  ioerr;</div>
<div class="line">    <span class="keywordtype">char</span>          error[256] = { 0 };</div>
<div class="line"> </div>
<div class="line">    (void)thunk;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (etype) {</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a571c000a93b3c198364a32e5e145f2d0">M_EVENT_TYPE_ACCEPT</a>:</div>
<div class="line">            ioerr = <a class="code" href="group__m__io.html#ga71d86bb1d3ea521f64005e7d31f90909">M_io_accept</a>(&amp;io_out, io);</div>
<div class="line">            <span class="keywordflow">if</span> (ioerr == <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2ace85a86b9ab6805d5838754b4c111c">M_IO_ERROR_WOULDBLOCK</a>) {</div>
<div class="line">                <span class="keywordflow">return</span>;</div>
<div class="line">            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ioerr != <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a> || io_out == NULL) {</div>
<div class="line">                <a class="code" href="group__m__io.html#ga3e1f56ec1e586649c1b26eb7c72238de">M_io_get_error_string</a>(io, error, <span class="keyword">sizeof</span>(error));</div>
<div class="line">                <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;ACCEPT FAILURE: %s\n&quot;</span>, error);</div>
<div class="line">                <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io_out);</div>
<div class="line">                <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">// If tracing, adding before the proxy protocol will output the proxy</span></div>
<div class="line">            <span class="comment">// protocol in the trace data. Putting after will not show the proxy</span></div>
<div class="line">            <span class="comment">// protocol data as it would have been eaten by the proxy protocol</span></div>
<div class="line">            <span class="comment">// layer, prior to being sent to the trace layer.</span></div>
<div class="line">            <span class="comment">//M_io_add_trace(io_out, NULL, do_trace, NULL, NULL, NULL);</span></div>
<div class="line"> </div>
<div class="line">            ldata = <a class="code" href="group__m__mem.html#ga9473a8ef59f5c85d37b3d35f461a82f1">M_malloc_zero</a>(<span class="keyword">sizeof</span>(*ldata));</div>
<div class="line">            ldata-&gt;el          = el;</div>
<div class="line">            ldata-&gt;write_buf   = <a class="code" href="group__m__buf.html#ga2031dcfdfa76f5feb5a59c8e7ac155d0">M_buf_create</a>();</div>
<div class="line">            ldata-&gt;read_parser = <a class="code" href="group__m__parser.html#gaf8100f8e139f41315478133992cc8ad1">M_parser_create</a>(<a class="code" href="group__m__parser.html#gga5f283601804b657a199f6574996ccf87a5879ad8c9fea3f4031268d7917b03933">M_PARSER_FLAG_NONE</a>);</div>
<div class="line">            ldata-&gt;io          = io_out;</div>
<div class="line">            ldata-&gt;sm          = <a class="code" href="group__m__state__machine.html#ga3477b2670869577b546e5033411df95c">M_state_machine_create</a>(0, NULL, <a class="code" href="group__m__state__machine.html#gga5172f2a4ea588087e85b9f44f99da78aa3996716d4796593cede212cbd06e22ec">M_STATE_MACHINE_NONE</a>);</div>
<div class="line">            <a class="code" href="group__m__state__machine.html#ga6e832f9aca09dc77eb4aeddb038b0508">M_state_machine_insert_state</a>(ldata-&gt;sm, STATE_CHECK, 0, NULL, state_check, NULL, NULL);</div>
<div class="line">            <a class="code" href="group__m__state__machine.html#ga6e832f9aca09dc77eb4aeddb038b0508">M_state_machine_insert_state</a>(ldata-&gt;sm, STATE_ECHO, 0, NULL, state_echo, NULL, NULL);</div>
<div class="line">            <a class="code" href="group__m__state__machine.html#ga6e832f9aca09dc77eb4aeddb038b0508">M_state_machine_insert_state</a>(ldata-&gt;sm, STATE_EXIT, 0, NULL, state_exit, NULL, NULL);</div>
<div class="line"> </div>
<div class="line">            <a class="code" href="group__m__event.html#ga755cf00991529e324be3f9f49a5d5476">M_event_add</a>(el, io_out, connection_cb, ldata);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7ab0fc60e031020cb3f36b70c4932d67f2">M_EVENT_TYPE_CONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a8d2cf32ca08773c695e988635ebfd426">M_EVENT_TYPE_READ</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a1713e94c1e0750f168d255f580fd4ad9">M_EVENT_TYPE_WRITE</a>:</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a6cead05362ca89b2cc7353bf6b4c2c6e">M_EVENT_TYPE_DISCONNECTED</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7adce269f93799cdca69ac20235895d0ac">M_EVENT_TYPE_ERROR</a>:</div>
<div class="line">        <span class="keywordflow">case</span> <a class="code" href="group__m__event.html#gga5d54358d8088f050bcdb141c6c0b21e7a89a67d4e5f2bdcadc1ffa3ba0473a6cf">M_EVENT_TYPE_OTHER</a>:</div>
<div class="line">            <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io);</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <a class="code" href="group__m__event.html#ga747f0301bfcc6db3b51eaf07e2582350">M_event_t</a>    *el;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a>       *io = NULL;</div>
<div class="line">    <a class="code" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a>  ioerr;</div>
<div class="line"> </div>
<div class="line">    ioerr = <a class="code" href="group__m__io__net.html#gabb60697b08a7ee07079ea683a1060747">M_io_net_server_create</a>(&amp;io, 8999, NULL, <a class="code" href="group__m__io__net.html#gga84d77b37b252e30d90cc6fd2a416267ea5f95bd5b48dcaf1f1d5e911c8bba2d32">M_IO_NET_ANY</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (ioerr != <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a>) {</div>
<div class="line">        <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;Could not start server: %s\n&quot;</span>, <a class="code" href="group__m__io.html#ga89a45c257b8b62345c2bc035da6cc4d0">M_io_error_string</a>(ioerr));</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    ioerr = <a class="code" href="group__m__io__proxy__protocol.html#gabe9d93489ff87f2a0b54a3bb7edb3e35">M_io_proxy_protocol_inbound_add</a>(io_out, NULL, <a class="code" href="group__m__io__proxy__protocol.html#gga07c46f091a99fdaac9e9bd23c599d67fa5bbdffd4b22645f75bd0cb9510fe50c8">M_IO_PROXY_PROTOCOL_FLAG_NONE</a>);</div>
<div class="line">    <span class="keywordflow">if</span> (ioerr != <a class="code" href="group__m__io.html#gga1ea9e3c1babf09b22f2b98899db790dba2778f41c2ec2dc7c612144ea5a591c30">M_IO_ERROR_SUCCESS</a>) {</div>
<div class="line">        <a class="code" href="group__m__fmt.html#gae54b252ea2bcf34b09ef1fa0f134ffa8">M_printf</a>(<span class="stringliteral">&quot;Could not add proxy protocol layer: %s\n&quot;</span>, <a class="code" href="group__m__io.html#ga89a45c257b8b62345c2bc035da6cc4d0">M_io_error_string</a>(ioerr));</div>
<div class="line">        <a class="code" href="group__m__io.html#ga1532f13c1f01fc1521b68a0f1d61c864">M_io_destroy</a>(io);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    el = <a class="code" href="group__m__event.html#gae169dca80125767d87fe196f32ea8d74">M_event_create</a>(<a class="code" href="group__m__event.html#gga72bc04891ff7b6142b7672a207ae74b1ac7efcb61cf28fa27d4a0a3daf68aaecf">M_EVENT_FLAG_NONE</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__m__event.html#ga755cf00991529e324be3f9f49a5d5476">M_event_add</a>(el, io, listen_cb, NULL);</div>
<div class="line">    <a class="code" href="group__m__event.html#gab5e0ea9055833a684aee9587252ed5fd">M_event_loop</a>(el, M_TIMEOUT_INF);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="group__m__event.html#ga603f06976101b21e00517deb529f86bb">M_event_destroy</a>(el);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="agroup__m__buf_html_gad226a7199f864ff6a630dc7f16508c30"><div class="ttname"><a href="group__m__buf.html#gad226a7199f864ff6a630dc7f16508c30">M_buf_add_str</a></div><div class="ttdeci">void M_buf_add_str(M_buf_t *buf, const char *str)</div></div>
<div class="ttc" id="agroup__m__event_html_gaf1b183d71c9f577e0779e9f44eb06896"><div class="ttname"><a href="group__m__event.html#gaf1b183d71c9f577e0779e9f44eb06896">M_event_done_with_disconnect</a></div><div class="ttdeci">void M_event_done_with_disconnect(M_event_t *event, M_uint64 timeout_before_disconnect_ms, M_uint64 disconnect_timeout_ms)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_ga4721163ab454a575722f3fd628702b71"><div class="ttname"><a href="group__m__io__proxy__protocol.html#ga4721163ab454a575722f3fd628702b71">M_io_proxy_protocol_proxied_type</a></div><div class="ttdeci">M_io_net_type_t M_io_proxy_protocol_proxied_type(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_ga4bb6960e44981297a6a01348252327e5"><div class="ttname"><a href="group__m__io__proxy__protocol.html#ga4bb6960e44981297a6a01348252327e5">M_io_proxy_protocol_source_ipaddr</a></div><div class="ttdeci">const char * M_io_proxy_protocol_source_ipaddr(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_gaa24ad926cb118e7260ebb5e26c8057b2"><div class="ttname"><a href="group__m__io__proxy__protocol.html#gaa24ad926cb118e7260ebb5e26c8057b2">M_io_proxy_protocol_dest_port</a></div><div class="ttdeci">M_uint16 M_io_proxy_protocol_dest_port(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_gabe9d93489ff87f2a0b54a3bb7edb3e35"><div class="ttname"><a href="group__m__io__proxy__protocol.html#gabe9d93489ff87f2a0b54a3bb7edb3e35">M_io_proxy_protocol_inbound_add</a></div><div class="ttdeci">M_io_error_t M_io_proxy_protocol_inbound_add(M_io_t *io, size_t *layer_id, M_uint32 flags)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_gad8431b167cf43e4f48690ab943272cab"><div class="ttname"><a href="group__m__io__proxy__protocol.html#gad8431b167cf43e4f48690ab943272cab">M_io_proxy_protocol_source_port</a></div><div class="ttdeci">M_uint16 M_io_proxy_protocol_source_port(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__proxy__protocol_html_gaeef527389ce51d5bfc88abf50cde416b"><div class="ttname"><a href="group__m__io__proxy__protocol.html#gaeef527389ce51d5bfc88abf50cde416b">M_io_proxy_protocol_dest_ipaddr</a></div><div class="ttdeci">const char * M_io_proxy_protocol_dest_ipaddr(M_io_t *io)</div></div>
<div class="ttc" id="agroup__m__io__trace_html_ga9de6468f493c8465ee53389d50c1dc87"><div class="ttname"><a href="group__m__io__trace.html#ga9de6468f493c8465ee53389d50c1dc87">M_io_trace_type_t</a></div><div class="ttdeci">enum M_io_trace_type M_io_trace_type_t</div><div class="ttdef"><b>Definition:</b> m_io_trace.h:54</div></div>
<div class="ttc" id="agroup__m__io__trace_html_gga906c49459ff07273bc2111733993ed69a08ed08ce37e683a12bf3a77dd62c468d"><div class="ttname"><a href="group__m__io__trace.html#gga906c49459ff07273bc2111733993ed69a08ed08ce37e683a12bf3a77dd62c468d">M_IO_TRACE_TYPE_READ</a></div><div class="ttdeci">@ M_IO_TRACE_TYPE_READ</div><div class="ttdef"><b>Definition:</b> m_io_trace.h:50</div></div>
<div class="ttc" id="agroup__m__io__trace_html_gga906c49459ff07273bc2111733993ed69a8156a9773735d37f3d4baf2446315f16"><div class="ttname"><a href="group__m__io__trace.html#gga906c49459ff07273bc2111733993ed69a8156a9773735d37f3d4baf2446315f16">M_IO_TRACE_TYPE_WRITE</a></div><div class="ttdeci">@ M_IO_TRACE_TYPE_WRITE</div><div class="ttdef"><b>Definition:</b> m_io_trace.h:51</div></div>
<div class="ttc" id="agroup__m__io_html_ga0fb4e2775a964a263f7ec0fa50be4023"><div class="ttname"><a href="group__m__io.html#ga0fb4e2775a964a263f7ec0fa50be4023">M_io_read_into_parser</a></div><div class="ttdeci">M_io_error_t M_io_read_into_parser(M_io_t *comm, M_parser_t *parser)</div></div>
<div class="ttc" id="agroup__m__parser_html_ga0d79542fe6a498f071bbcc8fcb081949"><div class="ttname"><a href="group__m__parser.html#ga0d79542fe6a498f071bbcc8fcb081949">M_parser_read_strdup_mark</a></div><div class="ttdeci">char * M_parser_read_strdup_mark(M_parser_t *parser)</div></div>
<div class="ttc" id="agroup__m__parser_html_ga3cd7b444d6f5058b149bc4c7262d5cb7"><div class="ttname"><a href="group__m__parser.html#ga3cd7b444d6f5058b149bc4c7262d5cb7">M_parser_destroy</a></div><div class="ttdeci">void M_parser_destroy(M_parser_t *parser)</div></div>
<div class="ttc" id="agroup__m__parser_html_ga60164be64f8c962c795e5927642fc473"><div class="ttname"><a href="group__m__parser.html#ga60164be64f8c962c795e5927642fc473">M_parser_t</a></div><div class="ttdeci">struct M_parser M_parser_t</div><div class="ttdef"><b>Definition:</b> m_parser.h:52</div></div>
<div class="ttc" id="agroup__m__parser_html_gab56a859c33b45f16a1af4134a502fc6c"><div class="ttname"><a href="group__m__parser.html#gab56a859c33b45f16a1af4134a502fc6c">M_parser_mark_rewind</a></div><div class="ttdeci">size_t M_parser_mark_rewind(M_parser_t *parser)</div></div>
<div class="ttc" id="agroup__m__parser_html_gad2f6bcc3999859f9bfabce4679697d30"><div class="ttname"><a href="group__m__parser.html#gad2f6bcc3999859f9bfabce4679697d30">M_parser_mark</a></div><div class="ttdeci">void M_parser_mark(M_parser_t *parser)</div></div>
<div class="ttc" id="agroup__m__parser_html_gae09ef7f274b45bbe005bb7f0d96ae011"><div class="ttname"><a href="group__m__parser.html#gae09ef7f274b45bbe005bb7f0d96ae011">M_parser_consume_until</a></div><div class="ttdeci">size_t M_parser_consume_until(M_parser_t *parser, const unsigned char *pat, size_t len, M_bool eat_pat)</div></div>
<div class="ttc" id="agroup__m__parser_html_gaf8100f8e139f41315478133992cc8ad1"><div class="ttname"><a href="group__m__parser.html#gaf8100f8e139f41315478133992cc8ad1">M_parser_create</a></div><div class="ttdeci">M_parser_t * M_parser_create(M_uint32 flags)</div></div>
<div class="ttc" id="agroup__m__parser_html_gafeb4f3232d2d842889823bdf70338ac6"><div class="ttname"><a href="group__m__parser.html#gafeb4f3232d2d842889823bdf70338ac6">M_parser_len</a></div><div class="ttdeci">size_t M_parser_len(M_parser_t *parser)</div></div>
<div class="ttc" id="agroup__m__parser_html_gga5f283601804b657a199f6574996ccf87a5879ad8c9fea3f4031268d7917b03933"><div class="ttname"><a href="group__m__parser.html#gga5f283601804b657a199f6574996ccf87a5879ad8c9fea3f4031268d7917b03933">M_PARSER_FLAG_NONE</a></div><div class="ttdeci">@ M_PARSER_FLAG_NONE</div><div class="ttdef"><b>Definition:</b> m_parser.h:60</div></div>
<div class="ttc" id="agroup__m__state__machine_html_ga3477b2670869577b546e5033411df95c"><div class="ttname"><a href="group__m__state__machine.html#ga3477b2670869577b546e5033411df95c">M_state_machine_create</a></div><div class="ttdeci">M_state_machine_t * M_state_machine_create(M_uint64 ndescr, const char *descr, M_uint32 flags)</div></div>
<div class="ttc" id="agroup__m__state__machine_html_ga5907f72a878c13dd0517d874af6dfd5f"><div class="ttname"><a href="group__m__state__machine.html#ga5907f72a878c13dd0517d874af6dfd5f">M_state_machine_run</a></div><div class="ttdeci">M_state_machine_status_t M_state_machine_run(M_state_machine_t *m, void *data)</div></div>
<div class="ttc" id="agroup__m__state__machine_html_ga6e832f9aca09dc77eb4aeddb038b0508"><div class="ttname"><a href="group__m__state__machine.html#ga6e832f9aca09dc77eb4aeddb038b0508">M_state_machine_insert_state</a></div><div class="ttdeci">M_bool M_state_machine_insert_state(M_state_machine_t *m, M_uint64 id, M_uint64 ndescr, const char *descr, M_state_machine_state_cb func, M_state_machine_cleanup_t *cleanup, M_list_u64_t *next_ids)</div></div>
<div class="ttc" id="agroup__m__state__machine_html_gac270a27ce03a23e30d86788b2103268b"><div class="ttname"><a href="group__m__state__machine.html#gac270a27ce03a23e30d86788b2103268b">M_state_machine_status_t</a></div><div class="ttdeci">M_state_machine_status_t</div><div class="ttdef"><b>Definition:</b> m_state_machine.h:565</div></div>
<div class="ttc" id="agroup__m__state__machine_html_gad576e0cce8ea03b5bfcffabfacfe6c14"><div class="ttname"><a href="group__m__state__machine.html#gad576e0cce8ea03b5bfcffabfacfe6c14">M_state_machine_t</a></div><div class="ttdeci">struct M_state_machine M_state_machine_t</div><div class="ttdef"><b>Definition:</b> m_state_machine.h:556</div></div>
<div class="ttc" id="agroup__m__state__machine_html_gaff67fd829b43aabe519c004d44cd0211"><div class="ttname"><a href="group__m__state__machine.html#gaff67fd829b43aabe519c004d44cd0211">M_state_machine_destroy</a></div><div class="ttdeci">void M_state_machine_destroy(M_state_machine_t *m)</div></div>
<div class="ttc" id="agroup__m__state__machine_html_gga5172f2a4ea588087e85b9f44f99da78aa3996716d4796593cede212cbd06e22ec"><div class="ttname"><a href="group__m__state__machine.html#gga5172f2a4ea588087e85b9f44f99da78aa3996716d4796593cede212cbd06e22ec">M_STATE_MACHINE_NONE</a></div><div class="ttdeci">@ M_STATE_MACHINE_NONE</div><div class="ttdef"><b>Definition:</b> m_state_machine.h:625</div></div>
<div class="ttc" id="agroup__m__state__machine_html_ggac270a27ce03a23e30d86788b2103268ba268c02ad158bd9a779c2a1226704a672"><div class="ttname"><a href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba268c02ad158bd9a779c2a1226704a672">M_STATE_MACHINE_STATUS_WAIT</a></div><div class="ttdeci">@ M_STATE_MACHINE_STATUS_WAIT</div><div class="ttdef"><b>Definition:</b> m_state_machine.h:598</div></div>
<div class="ttc" id="agroup__m__state__machine_html_ggac270a27ce03a23e30d86788b2103268ba99a33d04268a2612969eaf95a66aaa55"><div class="ttname"><a href="group__m__state__machine.html#ggac270a27ce03a23e30d86788b2103268ba99a33d04268a2612969eaf95a66aaa55">M_STATE_MACHINE_STATUS_NEXT</a></div><div class="ttdeci">@ M_STATE_MACHINE_STATUS_NEXT</div><div class="ttdef"><b>Definition:</b> m_state_machine.h:568</div></div>
<div class="ttc" id="agroup__m__str__check_html_ga5470a5985b0adb95aff5fc53780be8c7"><div class="ttname"><a href="group__m__str__check.html#ga5470a5985b0adb95aff5fc53780be8c7">M_str_eq</a></div><div class="ttdeci">M_bool M_str_eq(const char *s1, const char *s2)</div></div>
<div class="ttc" id="agroup__m__str__convert_html_ga92578e5f93242d414f9042c3d23ac7cb"><div class="ttname"><a href="group__m__str__convert.html#ga92578e5f93242d414f9042c3d23ac7cb">M_str_hexdump</a></div><div class="ttdeci">char * M_str_hexdump(int flags, size_t bytes_per_line, const char *line_prefix, const unsigned char *data, size_t data_len)</div></div>
<div class="ttc" id="agroup__m__str__convert_html_gga91fbd8e7976f8f06d8f54048585159efa58a3973b16170409c0588113d7ba4518"><div class="ttname"><a href="group__m__str__convert.html#gga91fbd8e7976f8f06d8f54048585159efa58a3973b16170409c0588113d7ba4518">M_STR_HEXDUMP_HEADER</a></div><div class="ttdeci">@ M_STR_HEXDUMP_HEADER</div><div class="ttdef"><b>Definition:</b> m_str.h:1875</div></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md75"></a>
Using Proxy Server and Echo Server Examples</h2>
<ol type="1">
<li>Compile the proxy server</li>
<li>Compile the echo server</li>
<li>Start proxy server</li>
<li>Start echo server</li>
<li>Use something like telnet to connect to the proxy server</li>
<li>You should see:<ul>
<li>Proxy server shows connection from telnet</li>
<li>Proxy server shows it connected to echo server</li>
<li>Echo server shows a connection from proxy server</li>
<li>Echo server shows proxied information for the <em>first</em> (in cases where the chain has been expanded to include multiple) proxy server(s) and the telnet client. </li>
</ul>
</li>
</ol>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="ga07c46f091a99fdaac9e9bd23c599d67f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga07c46f091a99fdaac9e9bd23c599d67f">&#9670;&nbsp;</a></span>M_io_proxy_protocol_flags_t</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="group__m__io__proxy__protocol.html#ga07c46f091a99fdaac9e9bd23c599d67f">M_io_proxy_protocol_flags_t</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Flags controlling behavior. </p>
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="gga07c46f091a99fdaac9e9bd23c599d67fa5bbdffd4b22645f75bd0cb9510fe50c8"></a>M_IO_PROXY_PROTOCOL_FLAG_NONE&#160;</td><td class="fielddoc"><p>Default operation. Support both V1 and V2 in inbound configuration. Send V2 in client configuration. </p>
</td></tr>
<tr><td class="fieldname"><a id="gga07c46f091a99fdaac9e9bd23c599d67fac8f1c35a2d4e078f9a4e1c369585a3d5"></a>M_IO_PROXY_PROTOCOL_FLAG_V1&#160;</td><td class="fielddoc"><p>Only allow V1 connections for inbound configuration. Receiving V2 is an error condition. Send V1 format for outbound connections. Specifying with V2 flag negates this flag operation. </p>
</td></tr>
<tr><td class="fieldname"><a id="gga07c46f091a99fdaac9e9bd23c599d67fadbd9012cd8e75280d765ca582d5dc1fc"></a>M_IO_PROXY_PROTOCOL_FLAG_V2&#160;</td><td class="fielddoc"><p>Only allow V2 connections for inbound configuration. Receiving V1 is an error condition. Send V2 format for outbound connections. Specifying with V1 flag negates this flag operation. </p>
</td></tr>
</table>

</div>
</div>
<h2 class="groupheader">Function Documentation</h2>
<a id="gabe9d93489ff87f2a0b54a3bb7edb3e35"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gabe9d93489ff87f2a0b54a3bb7edb3e35">&#9670;&nbsp;</a></span>M_io_proxy_protocol_inbound_add()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a> M_io_proxy_protocol_inbound_add </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *&#160;</td>
          <td class="paramname"><em>layer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">M_uint32&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Add an inbound handler for proxy protocol connections.</p>
<p>The system will look for the PROXY protocol data upon connect. If Proxy protocol data is not present this is considered an error condition per the proxy protocol spec. An error event will be generated instead of a connect event in this situation.</p>
<p>This should be added to an <code>io</code> object created by <code>M_io_accept</code> during a server <code>M_EVENT_TYPE_ACCEPT</code> event. It should not be added to the server <code>io</code> object created by <code>M_io_net_server_create</code>.</p>
<p>The proxy protocol data will be parsed and accessible though the relevant helper functions.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">layer_id</td><td>Layer id this is added at. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">flags</td><td>M_io_proxy_protocol_flags_t flags.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Result. </dd></dl>

</div>
</div>
<a id="gaa6382c849d8aeda4b03d365c6f811a60"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa6382c849d8aeda4b03d365c6f811a60">&#9670;&nbsp;</a></span>M_io_proxy_protocol_outbound_add()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__m__io.html#ga2d3bea9aaa4491c3c8dad94cf24498a2">M_io_error_t</a> M_io_proxy_protocol_outbound_add </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t *&#160;</td>
          <td class="paramname"><em>layer_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">M_uint32&#160;</td>
          <td class="paramname"><em>flags</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Add an outbound handler for proxy protocol connections.</p>
<p>Information about the proxyed endpoints (source and destination) need to be set before the connect event. If endpoints are not set the connection is assumed to be local where any data is being sent by the proxy itself and not being relayed on behalf of another client.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object. </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">layer_id</td><td>Layer id this is added at. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">flags</td><td>M_io_proxy_protocol_flags_t flags.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Result.</dd></dl>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="group__m__io__proxy__protocol.html#ga263a6cac977efe462bb133a1a562a7c6">M_io_proxy_protocol_set_source_endpoints</a> </dd></dl>

</div>
</div>
<a id="ga9c879581948a7071a96fd5c77c4db4b2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga9c879581948a7071a96fd5c77c4db4b2">&#9670;&nbsp;</a></span>M_io_proxy_protocol_relayed()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M_bool M_io_proxy_protocol_relayed </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Whether data is being is being relayed via a proxy.</p>
<p>A connection is relayed when the data is being sent on behalf of another system (proxied). When it is not relayed it is a local connection that has been established by the proxy for the proxy's own communication with the system. Typically, this is used for health checking.</p>
<p>return M_TRUE if relayed. Otherwise, M_FALSE. </p>

</div>
</div>
<a id="ga4bb6960e44981297a6a01348252327e5"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga4bb6960e44981297a6a01348252327e5">&#9670;&nbsp;</a></span>M_io_proxy_protocol_source_ipaddr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* M_io_proxy_protocol_source_ipaddr </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Source IP address.</p>
<p>IP address of the client that connected to the proxy.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>IP address as string. </dd></dl>

</div>
</div>
<a id="gaeef527389ce51d5bfc88abf50cde416b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaeef527389ce51d5bfc88abf50cde416b">&#9670;&nbsp;</a></span>M_io_proxy_protocol_dest_ipaddr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* M_io_proxy_protocol_dest_ipaddr </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Destination IP address.</p>
<p>IP address of the proxy server that is relaying the client's (source) data.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>IP address as string. </dd></dl>

</div>
</div>
<a id="gad8431b167cf43e4f48690ab943272cab"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gad8431b167cf43e4f48690ab943272cab">&#9670;&nbsp;</a></span>M_io_proxy_protocol_source_port()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M_uint16 M_io_proxy_protocol_source_port </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Source port.</p>
<p>Ephemeral port the client is connecting out on.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Port </dd></dl>

</div>
</div>
<a id="gaa24ad926cb118e7260ebb5e26c8057b2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa24ad926cb118e7260ebb5e26c8057b2">&#9670;&nbsp;</a></span>M_io_proxy_protocol_dest_port()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M_uint16 M_io_proxy_protocol_dest_port </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Destination port.</p>
<p>Destination port the client is connecting to.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Port </dd></dl>

</div>
</div>
<a id="ga4721163ab454a575722f3fd628702b71"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga4721163ab454a575722f3fd628702b71">&#9670;&nbsp;</a></span>M_io_proxy_protocol_proxied_type()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="group__m__io__net.html#ga0d3c956e19a647267f818beb367de6bc">M_io_net_type_t</a> M_io_proxy_protocol_proxied_type </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Connection type that was used between source and destination.</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object.</td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>Type </dd></dl>

</div>
</div>
<a id="ga5f11acf1e855088b6c899224c06003b8"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5f11acf1e855088b6c899224c06003b8">&#9670;&nbsp;</a></span>M_io_proxy_protocol_get_ipaddr()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* M_io_proxy_protocol_get_ipaddr </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Get the IP address of the client falling back to the network connection.</p>
<p>When using proxy protocol this should be used instead of <code>M_io_net_get_ipaddr</code> in most instances. This can be used even when proxy protocol is not in use. This is especially useful when using an internal IP based blacklist for denying connections to a client as part of an intrusion prevention system (IPS).</p>
<p>This function is the equivalent of checking <code>M_io_proxy_protocol_relayed</code> and then calling either <code>M_io_proxy_protocol_source_ipaddr</code> or <code>M_io_net_get_ipaddr</code> based on whether the connection is relayed.</p>
<p>This is a conscience especially for instances where proxy protocol could be used. For example, a configuration option or when some but not all connections will use the protocol. This function allows for use in both scenerios and will always return the correct IP address for the client, whether proxied for not.</p>
<p>param[in] io io object.</p>
<dl class="section return"><dt>Returns</dt><dd>String </dd></dl>

</div>
</div>
<a id="ga5004b110af7c31ec4dbbe2b6a0961eae"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5004b110af7c31ec4dbbe2b6a0961eae">&#9670;&nbsp;</a></span>M_io_proxy_protocol_set_connect_timeout_ms()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M_bool M_io_proxy_protocol_set_connect_timeout_ms </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">M_uint64&#160;</td>
          <td class="paramname"><em>timeout_ms</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Set connect timeout.</p>
<p>This is the timeout to wait for a connection to receive all proxy protocol data. This timeout applies after the net connect timeout.</p>
<p>Proxy protocol is designed for all data to fit within a single TCP frame. Meaning, the data should not buffer between multiple events. As such the default timeout is 500 ms. This function can be used to increase that timeout for obscenely slow connections.</p>
<p>Connect timeout applies to both inbound and outbound (receiving and writing), the proxy data.</p>
<p>param[in] io io object. param[in] timeout_ms Timeout in milliseconds.</p>
<dl class="section return"><dt>Returns</dt><dd>M_TRUE when proxy protocol in use. Otherwise, M_FALSE. </dd></dl>

</div>
</div>
<a id="ga263a6cac977efe462bb133a1a562a7c6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga263a6cac977efe462bb133a1a562a7c6">&#9670;&nbsp;</a></span>M_io_proxy_protocol_set_source_endpoints()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">M_bool M_io_proxy_protocol_set_source_endpoints </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="group__m__io.html#ga845c131d8520206a2a7a9219d1bd1932">M_io_t</a> *&#160;</td>
          <td class="paramname"><em>io</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>source_ipaddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&#160;</td>
          <td class="paramname"><em>dest_ipaddr</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">M_uint16&#160;</td>
          <td class="paramname"><em>source_port</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">M_uint16&#160;</td>
          <td class="paramname"><em>dest_port</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Source and destination information that will be sent on connect.</p>
<p>Only applies to outbound connections.</p>
<p>The source and destination IP address must be the same address family (IPv4/IPv6). If IP addresses are <code>NULL</code> the connection is assumed to be local (not proxied data).</p>
<p>This can be called multiple times setting or clearing proxy client information. However, the information is only sent on connect. Multiple inbound connections cannot be multiplexed on the same outbound connection. If changing endpoint information the outbound connection needs to disconnect first.</p>
<p>This should be called using an inbound network connection to determine the connection information.</p>
<div class="fragment"><div class="line"><a class="code" href="group__m__io__proxy__protocol.html#ga263a6cac977efe462bb133a1a562a7c6">M_io_proxy_protocol_set_source_endpoints</a>(io_out,</div>
<div class="line">    <a class="code" href="group__m__io__net.html#ga11f193aa2d827dcd1faf26dd20a3d2a0">M_io_net_get_ipaddr</a>(io_in),</div>
<div class="line">    <a class="code" href="group__m__io__net.html#ga9c00804a3f50b3cc60c4aa245b2a377c">M_io_net_get_server_ipaddr</a>(io_in),</div>
<div class="line">    <a class="code" href="group__m__io__net.html#ga9b5c7120aabf48773a689e3b17ddf33b">M_io_net_get_ephemeral_port</a>(io_in),</div>
<div class="line">    <a class="code" href="group__m__io__net.html#ga1ea4d8faa134421ebe9765d2c60e032a">M_io_net_get_port</a>(io_in));</div>
</div><!-- fragment --><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">io</td><td>io object. </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">source_ipaddr</td><td>Source ipaddress </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dest_ipaddr</td><td>Destination ipaddress </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">source_port</td><td>Source port </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">dest_port</td><td>Destination port </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Feb 24 2022 18:05:40 for Mstdlib-1.17.0 by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
